
# 1 OLDX-MocoMoco四足机器人开发平台项目  
<div align=center><img width="600" height="130" src="https://github.com/golaced/OLDX_DRONE_SIM/blob/rmd/support_file/img_file/logo.JPG"/></div>
<div align=center><img width="400" height="300" src="https://github.com/golaced/OLDX-FC_QUADRUPED_QUADROTOR/blob/rmd/support_file/img_file1/fc2.jpg"/></div>

  ____OLDX-MocoMoco四足机器人（OLDX-MocoMoco Quadruped）是目前国内首个真正意义上的开源足式机器人二次开发平台，团队已经开发了一套完整的免费开源
  项目OLDX-FC，随着近年来波士顿动力公司不断推出的足式机器人引起了国内外许多爱好者的关注，也出现了许多电子发烧友自己开发的足式机器人，但
  不同于四轴飞行器仅采用无刷电机和机架就能进行开发，而足式机器人本身结构复杂特别是伺服驱动部分可以独立作为一个学科进行研究，因此造成了
  虽然有许多不错的足式机器人项目但是由于项目成本或者编程语言不为国内环境所熟悉的原因而阻碍了它们的推广或开源。团队4年前就开始研发的六
  足机器人具有丰富的机器人，通过将其与所开发的飞控项目二次结合推出了MocoMoco四足机器人开发平台，囊括机器人结构、步态算法和SLAM无人驾驶
  等多个足式机器人核心技术内容。项目遵循GPL协议，能对DEMO内相关源码进行修改和二次开发。<br><br>

**-如果该项目对您有帮助请 Star 我们的项目-**<br>
**-如果您愿意分享对该项目的优化和改进请联系golaced@163.com或加入我们的QQ群567423074，加速开源项目的进度-**<br>

<br>
**-由于本人非专业研究四足机器人，该项目只是基于个人学术水平开发并不代表目前足式机器人算法就是这样，请不要过分依赖项目内容或与正规产品对比-**<br>
	
# 2 MocoMoco四足机器人平台介绍

 <div align=center><img width="550" height="300" src="https://github.com/golaced/OLDX-FC_QUADRUPED_QUADROTOR/blob/rmd/support_file/img_file1/r2.jpg"/></div>

____MocoMoco四足机器人是一个8自由度足式机器人其借鉴了GhostRobtic推出的Minitature机器人，之所以没有像波士顿动力或其他开发者一样采用
12自由度机器人是因为其在维护难度和成本上都大大提升，而8自由度机器人实际能完美的模拟12自由度单轴的控制特性能快速学习虚拟腿和
虚拟力相关步态理论，仅损失了部分侧向移动能力。同时对小体积足式机器人来首先与自身移动速度其相比外部环境来说不存绝对意义上狭窄
的区域，能满足绝大部分室内外场景下的可靠移动。<br>
____另外驱动采用固定位置安装的方式使用寿命和维护难度都有较大的优势，适合实验调试中可能出现的损坏等情况。为降低伺服驱动成本将其采用的无刷电机替换为高性能舵机,采用碳板和3D打印件作为主体结构具有安装方便，容易维护的特点，是一个桌面级的四足机器人研发和SLAM算法验证平台。控制器方面采用了目前国内开发群体较多的STM32和树莓派，同时该硬件架构将在后续机器人项目中沿用将首先移植OLDX-FC飞控项目实现真正的
一板多用的目的。电路板硬件方面采用了一体化集成设计采用最小推出的树莓派A3+具有小体积高性能的特点能为后续图像、激光雷达SLAM提供开发可能，
控制板采用STM32F4作为处理器，板载3轴加速度计、3轴陀螺仪、3轴磁力计和气压计采用内减震设计，电路安装孔能完美与树莓派安装同时提供3D打印外壳。
控制板采用外部可更换供电模块供电具有12路PWM输出和4路AD采样，并外扩4路串口兼容正点原子推出的无线调试其方面机器人不同调试。

**控制器硬件参数：**

项目|参数
-------------|-------------
处理器|STM32F405RGT6
处理器性能|32Bit ARM Cortex-M4 168MH
陀螺仪 加速度计|LSM6DS33 
磁力计|LIS3MDL
气压计|MS5611
预留接口|GPS-1 串口-4 AD采样-4 着地开关输入-4
PWM 输出通道| 12通道输出 
供电|5V输入 舵机外部供电  AD传感器3.3/5V供电选择
图像处理器|树莓派A3+  1.4G 4核  带独立供电开关(控制板兼容树莓派全系列可作为外扩IO板安装，但通讯仅采用引脚串口)
遥控方式|2.4G射频 SBUS航模遥控
地面站|QGround   匿名地面站(需要额外OLDX-REMOTE监视器)

**机器人参数：**

项目|参数
-------------|-------------
足式机器人类型|8自由度并联机器人
尺寸|30cm * 20cm *10cm  
全腿长|8cm
重量|600g
供电|7.4V  18650 * 2(3000mah  续航>35 min) 带开关 
步态支持|Tort步态  Fly-Trot步态  波动步态
最大移动速度|0.4m/s
最大转向速度|30度/s
步态周期|>0.35 s
舵机性能|Kpower 12g金属舵机 *8(6V-60度/0.035s  9kg扭矩)
足底传感器|薄膜压力/微动开关(默认无传感器)
控制模式|遥控模式  姿态平衡模式(有/无着地传感器)  驾驶模式  


<br>
**控制器PCB接口说明：**
<div align=center><img width="540" height="460" src="https://github.com/golaced/OLDX-FC_QUADRUPED_QUADROTOR/blob/rmd/support_file/img_file1/fc.jpg"/></div>
<br>

接口|说明|支持模块
-------------|-------------|-------------
飞控下载|飞控模块SWD下载口|download_fc模块 C->SCLK D->SWD
导航下载|导航模块SWD下载口|download_stlink模块
导航串口1|GPS和外部罗盘IIC接口|乐迪M8N Mini GPS C->SCL D->SDA
导航串口5|光流传感器接口|Pixflow  OLDX-AMF
导航串口3|超声波接口|US100 (串口模式下T->T R->R)  北醒激光测距模块
导航串口4|预留传感器接口|
导航CAN|预留CAN总线接口|
飞控串口3|图像处理接口|树莓派  Odroid-XU4 （图像处理器需自行供电）
飞控串口1|数传接口|匿名数传 3DR数传  CUAV WIFI数传
PWM1~8|电调接口|400Hz
AUX1~4|电调9~12/舵机控制接口 1俯仰 2横滚 3投递器开关|两轴舵机云台 两轴无刷云台
AD1~4|模拟电压采集接口|压力传感器AD(0~3.3V)
SBUS|接收机接口|天地飞接收机 Futaba接收机
舵机供电选择|R39外部供电 R38飞控供电 （任选一）|
供电|采用6P自锁双头端子线与供电模块连续|power模块 +->DC B->蜂鸣器信号 5->5V降压输入


# 3 DEMO测试
____该项目免费提供了基础测试的3D打印机架能免费下载自行打印，官方将推出全碳版本的机架请
关注淘宝店后续推出的第三方扩展模块，控制器同时兼任二者各版本机架所需螺丝型号如下：

金属件|数量(3D打印机架)|装配
-------------|-------------|----------
M3*30|8|安装机臂
M2*10|8|安装舵机
M3*5|8|安装腿
M3*10|4|安装足底
M3*15铜柱|4|中心体支撑
M1.4*4|8|固定齿轮
M2.5*3|4|安装电池盒
M2.5*5|8|固定控制器
M2.5铜柱*4|4|控制器支撑

金属件|数量(官方碳素机架)|装配
-------------|-------------|----------
M2*16|8|固定机臂
M2*5|8|安装舵机
M3*5|8|安装腿
M3*10|4|安装足底
M3*32铜柱|4|中心体支撑
M3*4|8|中心体固定
M1.4*4|8|固定齿轮
M2.5*3|4|安装电池盒
M2.5*5|8|固定控制器

**-搭建该项目的方式-**<br>



## 3.1 机器人组装（官方机架）
### 3.1.1 中心体和机臂组装


### 3.1.2 安装控制板和舵机


### 3.1.3 连接电子模块



## 3.2 腿部偏差校准与传感器校准


## 3.3 移动测试


## 3.4 使用STLink或正点原子无线下载器调试

## 3.5 高度和姿态Sin期望跟踪测试

## 3.6 参数调节

参数|说明|默认值
-------------|-------------|-------------
PID7-P|高度 内环P|500
PID7-I|高度 内环I|300
PID7-D|高度 内环D|1680
PID8-P|高度 外环P|1000
PID8-I|高度 外环I|100
PID8-D|高度 外环D|0
PID12-P|高度 ADRC b0|15
PID12-I||
PID12-D|高度 ADRC 死区|10


## 3.7 DEMO程序优化和后续开发建议
____DEMO程序为用户提供了一个最简单和四足机器人开发框架，包括了姿态解算和核心步态算法。所提供的步态算法以虚拟力为基础
通过雅克比矩阵输出扭矩，由于使用舵机因此仅通过简单的PD控制器变换为舵机旋转速度。在步态方面DEMO成像的整个状态机调度
结构与机器人库一样，只是简化了其中姿态控制策略采用了更简单直接的力控制方式，易于理解四足机器人最基础控制理论并能进一步进行
优化和改进。如果想深入对该项目进行开发并用于大型机器人中建议进一步研究SLIP模型、阻抗控制和柔顺控制理论，另外四足机器人
的核心有60%以上在可靠的伺服驱动，高效的伺服驱动系统能实现在最简单Sin轨迹+CPG算法下的可靠移动这一点已经被许多论文所
证明，机器人腿部结构设计也能在一定程度上提供自身稳定性。综上，后续升入开发建议如下：<br>
（1）优化腿部结构增加被动缓冲，构建12自由度机器人，增加着地传感器反馈<br>
（2）引入机器人倒立摆模型和基于模型先验知识下的优化控制、力矩控制<br>
（3）替换驱动系统采用无刷直驱或行星减速的结构提高各腿的一致性<br>
（4）引入视觉导航信息提高机器人移动的稳定性和足端轨迹的合理性


# 4 SDK开发
____该项目采用开源+机器人控制库授权的方式，即提供一个能运行机器人平台的基础项目源码同时提供高性能的闭源机器人控制库，
开源程序能进行修改和二次开发官方也会后续不断完善并与闭源机器人库一致。闭源机器人库则预留了完整的调用接口能基于SDK
快速地对机器人速度，姿态，足端轨迹，力矩等进行控制读取机器人位姿融合数据，即可采用现在SLAM小车底盘的开发方式对机器人进行
控制，二者具体功能区别如下：

**OLDX_VMC四足机器人数学库与开源DEMO版本的区别：**

项目|开源程序|闭源机器人库
-------------|--------------|-------------
步态算法|Trot|Fly-Tort  Tort  波动步态
步态理论|虚拟力|虚拟力
跨腿轨迹|摆线|最小Jerk轨迹  地面角度动态调节
足底传感器|无|压力  微动开关  震动传感器  距离传感器
图像导航|SDK开发|SDK开发
姿态控制|虚拟力闭环|位置+虚拟力闭环
速度闭环|机械参数估计|光流/视觉+机械参数估计
位置闭环|无|最小Jerk轨迹规划+ADRC轨迹跟踪
导航|光流  UWB  GPS|光流  UWB  GPS

## 4.1 获取授权库
____四足机器人数学库目前仅支持STM32F4系列单片机，数学库与单片机ID绑定一次性购买后则能永久使用且享受后续版本库的更新。
获取数学库前首先需要下载源码在watch中寻找并提供vmc_all.param.board_id对应的3个id。在向官方提供该ID并获取对应License
后修改源码中如下位置后即可正常使用否则在使用vmc.lib时不会为腿部进行供电和规划步态：

```
void vmc_init(void)
{ 	char i;
	get_license();
	//设置License
	vmc_all.param.your_key[0]=143;
	vmc_all.param.your_key[1]=42;
	vmc_all.param.your_key[2]=180;
```		

注：使用Demo程序需在vmc.h中定义#define USE_DEMO 1 否则默认使用数学库

## 4.2 测试

## 4.3 参数调节

参数|说明|默认值
-------------|-------------|-------------
PID7-P|高度 内环P|500
PID7-I|高度 内环I|300
PID7-D|高度 内环D|1680
PID8-P|高度 外环P|1000
PID8-I|高度 外环I|100
PID8-D|高度 外环D|0
PID12-P|高度 ADRC b0|15
PID12-I||
PID12-D|高度 ADRC 死区|10


## 4.4 将控制器用于其他四足机器人

## 4.5 SDK开发
____机器人开发采用ROS框架机器人控制器将作为一个硬件节点解算顶层控制命令，对机体中心点的姿态、速度和位置进行控制，同时也可以
对足端轨迹和力矩进行直接赋值。
<br>

target_track_downward_task|下置相机目标跟踪
-------------|-------------
target|目标图像信息结构体
spdz|下降速度
end_z|下降停止高度  
mode|模式 MODE_SPD：使用像素偏差  MODE_POS：使用估计的全局位置
完成条件|达到下降高度

<br><br>

target_track_pan_task|前置云台目标跟踪
-------------|-------------
target|目标图像信息结构体
close_param|速度模式下为云台最小角度  位置模式下为离目标距离
en_pitch|使能云台俯仰轴对准  
en_yaw|使能飞行器航向对准
close_mode|模式 MODE_SPD：使用像素偏差  MODE_POS：使用估计的全局位置
完成条件|云台达到目标角度或飞行器离目标距离达到设定值

<br><br>


# 5 捐赠与项目后续开发计划
____团队计划后期推出5kg级的足式机器人开发底盘，支持RPlidar激光雷达导航进行SLAM算法验证，能以相同的价格替代目前市面上同类的四轮小车平台如Autolabor等。
 <div align=center><img width="800" height="300" src="https://github.com/golaced/OLDX-FC_QUADRUPED_QUADROTOR/blob/rmd/support_file/img_file1/r1.jpg"/></div>
____如果您觉得该项目对您有帮助，也为了更好的项目推进和软硬件更新，如果愿意请通过微信捐赠该项目！
<div align=center><img width="240" height="300" src="https://github.com/golaced/OLDX_DRONE_SIM/blob/rmd/support_file/img_file/pay.png"/></div>





